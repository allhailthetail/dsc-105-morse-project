#+title: Main File - Morse Project
#+startup: indent overview hideblocks entitiespretty
#+PROPERTY: header-args:R :session *R* :results output :mkdirp yes

* Prerequisites
- [[file:functions.org][Supporting Functions]]

- Org tweaks:
  #+begin_src elisp
  (org-display-inline-images t)
  #+end_src

- *Configure the working directory:*
  #+begin_quote
  The project is assuming that R's working directory is the repository root. For simplicity, I set this up
  as an environment variable on my system, ~MORSE_ROOT~ and pointed R that as shown...
  #+end_quote

  #+begin_src R :results silent
# Get and set the working directory:
Sys.getenv("MORSE_ROOT") -> projectRoot
setwd(projectRoot)
getwd()
  #+end_src

- The following dependencies need to be installed so that the audio processing can take place:
  #+name: imports
  #+begin_src R :results silent
library(sonicscrewdriver)
library(tuneR)
source("R/project_functions.R")
  #+end_src

- Create directories for Plots, etc:
  #+begin_src bash :results silent
mkdir -p ../plots/general            # to store plots...
mkdir -p ../plots/waveforms/initial  # to store initial waveforms
mkdir -p ../R                        # to store tangled functions:
mkdir -p ../csv/                     # to store generated CSVs.
  #+end_src

- Tangle functions in =functions.org=
  #+begin_src emacs-lisp
(org-babel-tangle-file "functions.org")
  #+end_src

* Step 1: Exploratory Data Analysis:
- First, let's see how many files we're going to process and get some basic information about them:
  #+begin_src R
"./data" -> audio_files_path
list.files(audio_files_path,
           full.names=TRUE) -> audio_files # this is a vec of all our audio files

length(audio_files) # number of files to analyze...
  #+end_src

- Gathering basic metadata:
  #+begin_src R
basic_metadata <- wav_metadata_multi(audio_files)

summary(basic_metadata)

head(basic_metadata,2)
  #+end_src

  #+begin_quote
  - So, there's not a lot to see, but already we can draw some conclusions:
    1. We're dealing with approximately 36 minutes worth of data in total.
    2. All of it is mono audio, so we don't need to average the two channels
    3. There are more samples per file than would be efficient to graph as individual points,
       Luckily, tuneR has a special plot function that handles this...
  #+end_quote

- Filling in Known Predictions:
  - Handy Regex: (\d+),\s*(\w*) -> basic_metadata$prediction[\1] <- "\2"
    #+names: metadata - add predictions
    #+begin_src R :results silent
    basic_metadata$prediction <- NA

    basic_metadata$prediction[5] <- "FEFOFQUHYNZ3WONZRETF"
    basic_metadata$prediction[9] <- "5NITCM6O7M3VYTFUOLGB"
    basic_metadata$prediction[18] <- "NPAIUS139K2A5T2IQZY9"
    basic_metadata$prediction[22] <- "TF5E6V73PCP3C18OQIQ8"
    basic_metadata$prediction[25] <- "YQ4CBEH852FAR5AGTBS2"
    basic_metadata$prediction[26] <- "AVXDKKCKEB1EX8QABF7C"
    basic_metadata$prediction[27] <- "63BTNYH7OJ7XKBNYOV49"
    basic_metadata$prediction[28] <- "LGYI857RG7FXVFVGB7E3"
    basic_metadata$prediction[35] <- "8BKR52AIQ3SPVHAM2T2C"
    basic_metadata$prediction[37] <- "R2DX08BDJE46A0NU6ZT3"
    basic_metadata$prediction[41] <- "N5DAV420EZMYJ86MM2RF"
    basic_metadata$prediction[44] <- "BCYCKRK4YC1ACGOQ1771"
    basic_metadata$prediction[45] <- "89E536S85K7696K4824L"
    basic_metadata$prediction[47] <- "EZRXQHXYJZ4AIZ15AFFM"
    basic_metadata$prediction[49] <- "GWII2VNNDB5U74ZPYUUC"
    basic_metadata$prediction[50] <- "7KYQ1KSW9U7KWW9BW9CD"
    basic_metadata$prediction[53] <- "ET98RNOX26UAX013JLES"
    basic_metadata$prediction[62] <- "YWBRAOI6HLSTYKMIFQ8E"
    basic_metadata$prediction[71] <- "GKYGS8K1MQCHD15NCV9H"
    basic_metadata$prediction[72] <- "SIJP60T90447282IAP0G"
    basic_metadata$prediction[74] <- "K7OOLNPK60WUC5PC6L0X"
    basic_metadata$prediction[76] <- "KWOA6I12TE85P59HY272"
    basic_metadata$prediction[82] <- "B9MBJBCG088X5HEQFYBP"
    basic_metadata$prediction[84] <- "VS7FCHNSK6UBYHBG7Q6A"
    basic_metadata$prediction[90] <- "Y3POCL0TOB48OA23PP4X"
    basic_metadata$prediction[91] <- "TUB8FKBT1F0HDJC4E5JJ"
    basic_metadata$prediction[95] <- "TJ9DYTTIC1IEGOGDGKBG"
    basic_metadata$prediction[96] <- "FWRUHOKDX83UY4CXPGKT"
    basic_metadata$prediction[99] <- "8M9AGRKOW33JY9JC6P9E"
    basic_metadata$prediction[111] <- "EJGRJWSOJBATCY9YF93R"
    basic_metadata$prediction[115] <- "YYSH3K45WAXIY7EZHKIE"
    basic_metadata$prediction[118] <- "AOSXW13N9RQZ7CRZ7MJS"
    basic_metadata$prediction[119] <- "ZDPTZFSGG1ZQEOK4ORRB"
    basic_metadata$prediction[123] <- "OPIB1TZHIT8QNYBZ1P9O"
    basic_metadata$prediction[124] <- "H6I4HVYJH8DFEEPM4PCT"
    basic_metadata$prediction[128] <- "XW8XLJ2K9O5V12LLT4Q9"
    basic_metadata$prediction[129] <- "P299MVR0XGG51UWPSNKR"
    basic_metadata$prediction[130] <- "0JOJRS92O0TPMJQDTNHC"
    basic_metadata$prediction[148] <- "RS00DAAA04UVGG3WALGS"
    basic_metadata$prediction[149] <- "A9N0QQ8IFFZ0Z89LYNFI"
    basic_metadata$prediction[151] <- "K3ZC88XILS6Y9WPJWAUI"
    basic_metadata$prediction[152] <- "WMDQP6JCDDU6U8LEWVZY"
    basic_metadata$prediction[155] <- "6H2NCKWC0HFH00JGYY7R"
    basic_metadata$prediction[157] <- "3XIVCTHI5M7QAWIS7UL0"
    basic_metadata$prediction[158] <- "JO0G95ECU0SBO7N2QOVD"
    basic_metadata$prediction[159] <- "LUS34SYEYV7H1CNKXF8M"
    basic_metadata$prediction[161] <- "7F2PQX5LVC1XV9ZYTRR3"
    basic_metadata$prediction[165] <- "0S8PT84E5DU0ZMX4OD91"
    basic_metadata$prediction[166] <- "216PENQ5527G3YQ4Z4DE"
    basic_metadata$prediction[167] <- "QMWHZO5E67APYHM3JL5M"
    basic_metadata$prediction[171] <- "W10IQ4YD09M01A8WJOHP"
    basic_metadata$prediction[175] <- "03IWB4JYRUE2LBPMN5X1"
    basic_metadata$prediction[176] <- "E8G8V81FIYVERSUPKPJY"
    basic_metadata$prediction[178] <- "1UPUX15HK586V8Q1DK4W"
    basic_metadata$prediction[180] <- "PG8BUHZGV31HO9YMICWC"
    basic_metadata$prediction[188] <- "YQYXB1LM2SNGPBTHHJ1D"
    basic_metadata$prediction[194] <- "FJQSR2P1Y2T2XU5RK63T"
    basic_metadata$prediction[199] <- "ZEA2Y4H4NX6JST0J3IY8"
    #+end_src

- So, let's get a basic idea of what the files look like with some plots:
  - [[file:~/playground/morse-project/plots/waveforms/initial/][Output Directory]]
    #+begin_src R :results silent
  audio_files <- basic_metadata$filename
  plot_waveforms(audio_files, "./plots/waveforms/initial")
    #+end_src

    #+begin_quote
  Some, like [[file:~/playground/morse-project/plots/waveforms/initial/cw002.png][cw002]] and [[file:~/playground/morse-project/plots/waveforms/initial/cw003.png][cw003]] seem to be readable with no adjustments:
  CW002: WRBCDGB5T1JNN63C3MR3
  CW003: G1FNCKUDZ63TSIJ5QH47
    #+end_quote

- Boxplot of the durations:
  #+begin_src R :file ../plots/general/dur-hist.png :results file graphics
summary_duration <- summary(basic_metadata$duration)
mean_text <- paste("Mean:", round(summary_duration["Mean"], 2), "sec")

hist(x = basic_metadata$duration, xlab = "seconds", main = "Audio File Durations in Seconds", col = "lightblue")
abline(v = summary_duration["Mean"], col = "red")
abline(v = summary_duration["1st Qu."], col = "dark grey")
abline(v = summary_duration["3rd Qu."], col = "dark grey")
text(x = 20, y = 40, labels = mean_text, col = "black", cex = 1.5)
  #+end_src


  #+begin_quote
  Remember, this is a graphical representation of what summary already says:
  > summary(basic_metadata$duration)
     Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
    4.666   6.742   9.129  10.815  13.222  27.121

  So, the files are typically no less than ~6-3/4 seconds in length, no more than ~13-1/4 seconds...
  The skew shows that there are outlier files that are particularly long. The original dataset did mention that there was corruption in the initial upload, so that should be investigated.
  #+end_quote

- Investigating long files outside Q3:
  #+begin_src R
q3 <- 13.222
above_q3 <- basic_metadata$duration > q3

basic_metadata[above_q3,]

numChars <- nchar(basic_metadata$prediction[27])
numChars
  #+end_src

  #+begin_quote
  Actually, I do see a pattern now that the data is visualized and in a table...
  Conveniently for us, every message seems to contain 20 characters. That means that we can get a good estimate of
  the words per minute for each file with no extra effort!! Perfect for training a model...

  WPM = (60s x numChars/5)/time
  WPM = 12 x numChars / time
  #+end_quote

- Let's add Words Per Minute to the Metadata:
  #+begin_src R
approx_wpm <- round((12 * numChars) / basic_metadata$duration, 2)
basic_metadata$approx_wpm <- approx_wpm
head(basic_metadata)
summary(basic_metadata$approx_wpm)
  #+end_src

  #+begin_src R :file ../plots/general/wpm-approx.png :results file graphics
  # And, we'll visualize that as well...
  summary_wpm <- summary(basic_metadata$approx_wpm)
  mean_wpm <- summary_wpm["Mean"]
  q1_wpm <- summary_wpm["1st Qu."]
  q3_wpm <- summary_wpm["3rd Qu."]

  hist(x = basic_metadata$approx_wpm, xlab = "Words per Minute", main = "Estimated WPM values for Audio Clips", col = "lightblue")
  abline(v = mean_wpm, col = "red")
  abline(v = q1_wpm, col = "dark grey")
  abline(v = q3_wpm, col = "dark grey")
  #+end_src

  https://github.com/allhailthetail/LyonCoursework[[file:../plots/general/wpm-approx.png]]

  #+begin_quote
  So, most of our morse code data will be between 18 and 35.6 WPM...
  #+end_quote

- Export Initial Data to CSV
  #+begin_src R
  write.csv(basic_metadata, file = "./csv/basic_metadata.csv")
  #+end_src

* Step 2: Audio Signal Summaries:
- Copy the dataframe
  #+begin_src R
detailed_analysis <- basic_metadata
  #+end_src

- Exploring mean amplitude / "roughness"

- RMS Amplitude / average energy
  #+begin_src R
rms_amplitudes(basic_metadata$filename) -> detailed_analysis$rms_amplitude
detailed_analysis
  #+end_src

  - Now, we should be able to see from the rms which are clearer and more noisy files:
    #+begin_src R
min(detailed_analysis$rms_amplitude) -> low_rms
max(detailed_analysis$rms_amplitude) -> high_rms

detailed_analysis[detailed_analysis$rms_amplitude == low_rms,]
detailed_analysis[detailed_analysis$rms_amplitude == high_rms,]
    #+end_src

    Sure enough, CW092 looks quite terrible, whereas CW074 is quite clear. This is probably what we're looking to optimize...

    [[file:~/playground/morse-project/plots/waveforms/initial/cw092.png][Graphic - cw092]]
    [[file:~/playground/morse-project/plots/waveforms/initial/cw074.png][Graphic - cw074]]

- Zero-crossing rate / measure of noise

- Detecting gaps and periods of silence

- Spectral centroid

* Pre-commit Clean-up:
- Remove Generated Files
  #+begin_src bash :results silent :noeval
rm -r ../plots  # Remove plots dir...
rm -r ../csv    # Remove csv data
rm -r ../R      # Dir of supporting functions
rm -r ../.Rhistory # R history file
  #+end_src
- Clean up Babel output blocks:
  #+begin_example elisp
(+org/remove-result-blocks)
  #+end_example
